<div class="layui-fluid" id="VIEW-list-table" lay-title="Pesquisa de clientes">
    <script type="text/html" id="dataListBar">
        <a class="layui-btn layui-btn-sm" lay-event="add"><i class="layui-icon layui-icon-add-1"></i>Novo</a>
        <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="batchDel"><i class="layui-icon layui-icon-delete"></i>Excluir Selecionados</a>
        <div class="layui-inline">
            <input type="text" name="nome" placeholder="Digite o que deseja encontrar" autocomplete="off" class="layui-input">
        </div>
        <div class="layui-inline nepadmin-br-red" >
            <button class="layui-btn layui-btn-primary layui-btn-sm" style="width: 70px;" lay-submit="" lay-filter="search">Pesquisar</button>
            <button class="layui-btn layui-btn-primary layui-btn-sm" style="width: 70px;" lay-event="reset">Restaurar</button>
            <button class="layui-btn layui-btn-primary layui-btn-sm" style="width: 30px;">...</button>
        </div>
    </script>

    <table class="layui-hide" id="dataList" lay-filter="dataList"></table>

</div>
<script th:inline="javascript">

    layui.use('table', function(){
        var table = layui.table;

        table.render({
            elem: '#dataList'
            ,url:'client/lists'
            ,title: 'Clientes'
            ,cellMinWidth: 100
            ,height: 'full-100'
            ,size: 'sm' //forma pequena
            ,page: true
            ,loading:true
            ,autoSort:true            
            ,toolbar: '#dataListBar'
            ,cols:[[ //cabeçalho
                {type: 'checkbox', fixed: 'left'}
                ,{field: 'mid', width: 100, title: 'Id',width:"6%",}
                ,{field: 'nome', title: 'Nome da cliente', sort: true, width:"32%"}
                ,{field: 'contato_nome', title: 'Contato', width:"10%"}
                ,{field: 'telefone1', title: 'Telefone 1', width:"10%"}
                ,{field: 'telefone2', title: 'Telefone 2', width:"10%"}
                ,{field: 'email', title: 'Email', width:"15%"}
                ,{title: 'Ação', align:'center', width: "13%"
                    ,templet: function(d){
                        var html='';
                        var editBtn='<a title="Alterar" class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit"><i class="layui-icon">&#xe642;</i></a>';
                        var delBtn='<a title="Excluir" class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon">&#xe640;</i></a>';
                        return editBtn+delBtn;                        
                    }
                }
            ]]
            ,response: {
                statusCode: 200
            }
        });

        //Ouvir eventos da barra de ferramentas do cabeçalho
        table.on('toolbar(dataList)', function(obj){
            var checkStatus = table.checkStatus(obj.config.id)
                ,data = checkStatus.data; //Obter dados selecionados
            switch(obj.event){
                case 'add':
                    addOrEdit(obj,true);
                    break;
                case 'update':
                    if(data.length === 0){
                        layer.msg('Selecione uma linha');
                    } else if(data.length > 1){
                        layer.msg('Apenas um pode ser editado por vez');
                    } else {
                        layer.alert('editar [id]:'+ checkStatus.data[0].id);
                    }
                    break;
                case 'batchDel':
                    if(data.length === 0){
                        layer.msg('Selecione no mínimo uma linha');
                    } else {
                        layer.msg('excluir:' + data.length + ' linhas' + '    ---> Falta implementar'),
                        function reload(){
                            $(".layui-laypage-btn")[0].click();
                        }
                    }
                    break;
            };
        });

        // evento de linha
        table.on('tool(dataList)',function (obj) {
            if(obj.event === 'del'){//excluir linha
                del(obj);
            }else if(obj.event==="edit"){//linha de edição
                addOrEdit(obj,false);
            }else if(obj.event === "bindDbSource"){
                // vincular fonte de dados
                gotoBindDbSource(obj);
            }else if(obj.event === "viewDbSource"){
                // Ver fontes de dados
                gotoViewDbSource(obj);
            }
        });
    });

    
    // Editar
    function addOrEdit(obj,isAdd) {
        var data=obj?obj.data:null;
        var id=data?data.mid:null;
        var url;

        if(isAdd){
            url = "/client/save";
        }else{
            url = "/client/save?id="+id;
        }

        //table.navigate(url);

        parent.editPopupIndex = parent.layer.open({
            type: 2,
            area: [ '500px', '550px'],
            fix: false, //não corrigido
            maxmin: false,
            shade: 0.4,
            title: isAdd ? 'Novo Cliente' : "Alterar Cliente :"+id,
            content: url,
            end:function(index){
                reload();
            }
        });      

    }


    /**Abra a página de encadernação**/
    function gotoBindDbSource(obj) {
        var data=obj?obj.data:null;
        var id=data?data.mid:null;
        var url= "/client/save?id=" + id;

        console.log(url);
        parent.editPopupIndex = parent.layer.open({
            type: 2,
            area: [ '600px', '700px'],
            fix: false, //não consertado
            maxmin: false,
            shade: 0.4,
            title: 'Novo/Editar interface',
            content: url,
            end:function(index){
                reload();
            }
        });
    }


    /** Exibir informações da fonte de dados **/
    function gotoViewDbSource(obj){
        var data=obj?obj.data:null;
        var id=data?data.mid:null;
        var url= "/client/save?id=" + id;

        parent.editPopupIndex = parent.layer.open({
            type: 2,
            area: [ '600px', '700px'],
            fix: false, //Não corrigido
            maxmin: false,
            shade: 0.4,
            title: 'Adicionar/editar interface',
            content: url,
            end:function(index){
                reload();
            }
        });
    }

    //Apagar cliente
    function del(obj) {
        layer.confirm("Tem certeza que deseja excluir os dados?", {icon: 3,title: 'Confirme', btn: ["Sim","Não"]},
            function (index) {//OK callback
                admin.post({
                    api: "delClient",
                    data: {id: obj.data.mid},
                    success: function (res) {
                        layer.msg(res.msg, {
                            icon: 1,
                            time: 800 //2 segundos desligado (se não configurado, o padrão é 3 segundos)
                        }, function () {
                            layui.view.tab.refresh();
                            obj.del();
                            layer.close(index);
                        });
                    },
                    error: function (res) {
                        layer.msg(res.msg, {
                            icon: 2,
                            time: 800 //2 segundos desligado (se não configurado, o padrão é 3 segundos)
                        }, function () {
                            layui.view.tab.refresh();
                        });
                    },
                })
            }, function (index) {//cancelar
                layer.close(index);
            }
        );
    }

    //atualização de página
    function reload(){
        $(".layui-laypage-btn")[0].click();
    }

</script>

